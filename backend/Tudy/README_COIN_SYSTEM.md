# 🪙 Tudy 코인 시스템

Tudy 프로젝트에 추가된 새로운 코인 시스템에 대한 설명입니다.

## 🎯 **코인 종류**

### 1. **학과&새도 코인**
- 공부(STUDY) 목표 완료 시 → **50개** 지급
- 기타(ETC) 목표 완료 시 → **20개** 지급

### 2. **체육관 코인**
- 운동(EXERCISE) 목표 완료 시 → **50개** 지급

### 3. **카페 코인**
- 향후 카페 인증 시스템으로 획득 예정

## 🏗️ **시스템 구조**

### 핵심 클래스들
- `CoinType` - 코인 타입 enum (ACADEMIC_SAEDO, GYM, CAFE)
- `UserCoin` - 사용자별 코인 보유량 엔티티
- `UserCoinRepository` - 코인 데이터 접근
- `CoinService` - 코인 비즈니스 로직
- `CoinController` - 코인 API 엔드포인트

### 기존 시스템과의 연동
- `GoalService` - 목표 완료 시 자동 코인 지급
- `User.coinBalance` - **모든 종류 코인의 총합** (자동 업데이트)

## 📡 **API 엔드포인트**

### 1. 사용자의 모든 코인 조회
```http
GET /api/coins
Authorization: Bearer {token}
```

**응답:**
```json
[
  {
    "id": 1,
    "coinType": "ACADEMIC_SAEDO",
    "amount": 150,
    "user": { "id": 1, "email": "user@example.com" }
  },
  {
    "id": 2,
    "coinType": "GYM",
    "amount": 50,
    "user": { "id": 1, "email": "user@example.com" }
  }
]
```

### 2. 특정 타입 코인 조회
```http
GET /api/coins/{coinType}
Authorization: Bearer {token}
```

**경로 변수:**
- `coinType`: `ACADEMIC_SAEDO`, `GYM`, `CAFE`

**응답:**
```json
{
  "id": 1,
  "coinType": "ACADEMIC_SAEDO",
  "amount": 150,
  "user": { "id": 1, "email": "user@example.com" }
}
```

### 3. 총 코인 수량 조회 (새로 추가!)
```http
GET /api/coins/total
Authorization: Bearer {token}
```

**응답:**
```json
{
  "totalCoins": 200,
  "userId": "user1",
  "userName": "김철수"
}
```

## 🎯 **코인 획득 방법**

### 자동 지급 시스템
목표를 완료하면 **자동으로** 해당 카테고리 타입에 맞는 코인이 지급됩니다:

1. **공부 목표 완료** → 학과&새도 코인 50개
2. **운동 목표 완료** → 체육관 코인 50개  
3. **기타 목표 완료** → 학과&새도 코인 20개

### 목표 완료 조건
- **시간 인증**: 설정된 목표 시간 달성 시
- **이미지 인증**: 사진 업로드 완료 시

## 🔄 **coinBalance 자동 업데이트**

### **새로운 역할**
- `User.coinBalance`는 이제 **모든 종류 코인의 총합**을 나타냅니다
- 코인 지급 시마다 자동으로 계산되어 업데이트됩니다

### **계산 방식**
```java
// 예시: 사용자가 보유한 코인들
학과&새도 코인: 150개
체육관 코인: 50개
카페 코인: 0개

// User.coinBalance = 150 + 50 + 0 = 200
```

### **자동 업데이트 시점**
- 목표 완료 시 코인 지급 후 즉시 업데이트
- `CoinService.updateUserTotalCoinBalance()` 메서드로 처리

## 🗄️ **데이터베이스 스키마**

### 새로운 테이블: user_coins
```sql
CREATE TABLE user_coins (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL,
    coin_type VARCHAR(20) NOT NULL CHECK (coin_type IN ('ACADEMIC_SAEDO', 'GYM', 'CAFE')),
    amount INTEGER NOT NULL DEFAULT 0,
    CONSTRAINT fk_user_coin_user FOREIGN KEY (user_id) REFERENCES users(id),
    CONSTRAINT uq_user_coin_type UNIQUE (user_id, coin_type)
);
```

### 특징
- 사용자별로 각 코인 타입마다 하나의 레코드
- 초기 생성 시 amount = 0
- 목표 완료 시마다 해당 코인 타입의 amount 증가
- **User.coinBalance는 모든 코인 종류의 합계로 자동 업데이트**

## 🔧 **설정 및 실행**

1. **프로젝트 빌드**
```bash
./gradlew build
```

2. **애플리케이션 실행**
```bash
./gradlew bootRun
```

## 📝 **주요 특징**

- ✅ **자동 코인 지급**: 목표 완료 시 자동으로 적절한 코인 지급
- ✅ **카테고리별 분류**: 목표의 카테고리 타입에 따라 다른 코인 지급
- ✅ **자동 총합 계산**: User.coinBalance가 모든 코인 종류의 총합으로 자동 업데이트
- ✅ **하위 호환성**: 기존 coin_balance 필드 활용
- ✅ **트랜잭션 처리**: 안전한 코인 지급
- ✅ **확장 가능**: 향후 카페 코인 등 추가 코인 타입 확장 준비

## 🎯 **사용 예시**

### 1. 공부 목표 완료
```
목표: "수학 공부 2시간"
카테고리: STUDY
완료 시 → 학과&새도 코인 50개 획득
User.coinBalance 자동 업데이트: 0 → 50
```

### 2. 운동 목표 완료
```
목표: "헬스장 운동 1시간"
카테고리: EXERCISE
완료 시 → 체육관 코인 50개 획득
User.coinBalance 자동 업데이트: 50 → 100
```

### 3. 코인 조회
```bash
GET /api/coins                    # 모든 코인 상세 조회
GET /api/coins/ACADEMIC_SAEDO    # 학과&새도 코인만 조회
GET /api/coins/GYM               # 체육관 코인만 조회
GET /api/coins/total             # 총 코인 수량 조회
```

## 🚀 **향후 확장 계획**

- 카페 인증을 통한 카페 코인 획득
- 코인을 사용한 아이템 구매 시스템
- 친구와의 코인 거래
- 코인 히스토리 추적
- 랭킹 시스템

이제 사용자들이 목표를 달성할 때마다 자동으로 적절한 코인을 획득하고, `User.coinBalance`에는 모든 코인의 총합이 자동으로 반영됩니다! 🎉
